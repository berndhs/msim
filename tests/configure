#!/bin/bash

# configure script for
#
#  msimtest
#
# Copyright (C) 2011 Bernd Stramm
#

#/****************************************************************
# *
# * Copyright (C) 2011, Bernd Stramm
# *
# *  This program is GPL2 software
# *
# ****************************************************************/
#


#
# function to find distro
#
find_distro () {
DISTRO=linux
if [ -e /etc/system-release ]
then
  DISTRO=`head -1 /etc/system-release \
         | awk '{print $1}' \
         | tr '[:upper:]' '[:lower:]'`
else
  if [ -e /etc/issue ]
  then
    DISTRO=`head -1 /etc/issue \
	| awk '{print $1}' \
	| tr '[:upper:]' '[:lower:]'`
  fi
fi
}
#
# function to tell the user about options
#
usage () {
   echo 
   echo "$0 [OPTIONS]"
   echo
   echo "Options:"
   echo "--help               Show this help message and quit"
   echo "--prefix=PREFIX      Install into PREFIX [${PREFIX}]"
   echo "--distro=DISTRO      Build for distro [${DISTRO}]"
   echo "--target=TESTTARGET  Test target <source | installed> [$TESTTARGET]"
   echo
}


#
# main configure script
#

COPYRIGHT=" Copyright (C) 2010 Bernd Stramm"
PREFIX=/usr
OPTIONS_FILE=make.inc
TESTTARGET=source
find_distro

# 
# command line arguments:
# see if they said anything about prefix
#
while test $# != 0
do
  case $1 in
  --*=*)
  ac_option=`expr "X$1" : 'X\([^=]*\)='`
  ac_optarg=`expr "X$1" : 'X[^=]*=\(.*\)'`
  ac_shift=:
  ;;
 *)
  ac_option=$1
  ac_optarg=$2
  ac_shift=shift
  ;;
  esac

case $ac_option in
  --help)
   usage
   exit 0
   ;;
  --prefix)
   PREFIX=$ac_optarg
   $ac_shift
   ;;
  --distro)
   DISTRO=$ac_optarg
   $ac_shift
   ;;
  --target)
   TEST_TARGET =$ac_optarg
   $ac_shift
   ;;
  *)
   echo "Bad option " $ac_option " " $ac_optarg
   usage
   shift
   ;;
  esac
shift

done 

#
# see if we are on windows and need a special name for "make"
#

OSLEN=`expr match "Z$OS" "ZWindow"`
if [ $OSLEN -gt 5 ] ; then
  MAKE_PROGRAM="mingw32-make.exe"
  DISTRO="win32"
else
  MAKE_PROGRAM="make"
fi

#
# make options include file
#
echo "DISTRO = ${DISTRO}" > ${OPTIONS_FILE}
echo "CONFIG += ${DISTRO}" >> ${OPTIONS_FILE}
echo "TESTTARGET += ${TESTTARGET}" >> ${OPTIONS_FILE}
echo "DEFINES += -DDISTRO_${DISTRO}=1" >> ${OPTIONS_FILE}
if [ X$TESTTARGET == "Xsource" ]
then
  echo "DEFINES += -DTEST_SOURCE=1" >> ${OPTIONS_FILE}
  echo "DEFINES += -DTEST_INSTALLED=0" >> ${OPTIONS_FILE}
else
  echo "DEFINES += -DTEST_SOURCE=0" >> ${OPTIONS_FILE}
  echo "DEFINES += -DTEST_INSTALLED=1" >> ${OPTIONS_FILE}
fi
#
# generate Makefile
#
# first shove in everything we found out
#
echo "#" > Makefile
echo "# Makefile generated by configure" >> Makefile
echo "# Faux automake" >> Makefile
echo "# ${COPYRIGHT}" >> Makefile
echo "#" >> Makefile
echo "PREFIX=${PREFIX}" >> Makefile
echo "DESTDIR=\${PREFIX}/bin" >> Makefile
echo "MAKE = ${MAKE_PROGRAM}" >> Makefile
#
# next concatenate the Makefile.in content
#
cat Makefile.in >> Makefile
#
# make secondary files
#
make make.dep

#
# tell the user what to do next
#
showmsg () {
  echo "     " $* 
  echo $* >> config.last
}

echo "" > config.last
showmsg ""
showmsg 'Installation prefix is....' $PREFIX 
showmsg 'Distro setting is.........' $DISTRO
showmsg 'Test Target...............' $TESTTARGET
showmsg 'Now you can build with....' $MAKE_PROGRAM 

